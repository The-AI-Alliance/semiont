#!/usr/bin/env bash

# Semiont management wrapper script
# Usage: ./semiont [command] [args...]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Ensure dependencies are installed
if [ ! -d "$SCRIPT_DIR/node_modules" ]; then
    echo "üì¶ Installing dependencies..."
    cd "$SCRIPT_DIR" && npm install
fi

COMMAND=${1:-help}

case $COMMAND in
  "watch")
    shift
    cd "$SCRIPT_DIR" && npx tsx watch.ts "$@"
    ;;
  "check")
    shift  
    cd "$SCRIPT_DIR" && npx tsx check.ts "$@"
    ;;
  "configure")
    shift
    # Check if this is for local development
    if [[ "$1" == "local" ]] || [[ "$SEMIONT_ENV" == "development" && "$1" == "set" && ("$2" == "database-password" || "$2" == "jwt-secret") ]]; then
      if [[ "$1" == "local" ]]; then
        shift  # Remove 'local' from arguments
      fi
      cd "$SCRIPT_DIR" && npx tsx local-secrets.ts "$@"
    else
      cd "$SCRIPT_DIR" && npx tsx configure.ts "$@"
    fi
    ;;
  "start")
    shift
    cd "$SCRIPT_DIR" && npx tsx start.ts "$@"
    ;;
  "stop")
    shift
    cd "$SCRIPT_DIR" && npx tsx stop.ts "$@"
    ;;
  "restart")
    shift
    cd "$SCRIPT_DIR" && npx tsx restart.ts "$@"
    ;;
  "exec")
    shift
    cd "$SCRIPT_DIR" && npx tsx exec.ts "$@"
    ;;
  "backup")
    shift
    cd "$SCRIPT_DIR" && npx tsx db-backup.ts "$@"
    ;;
  "provision")
    shift
    cd "$SCRIPT_DIR" && npx tsx provision.ts "$@"
    ;;
  "deploy")
    shift
    cd "$SCRIPT_DIR" && npx tsx deploy.ts "$@"
    ;;
  "clean")
    shift
    cd "$SCRIPT_DIR" && npx tsx clean.ts "$@"
    ;;
  "build")
    shift
    cd "$SCRIPT_DIR" && npx tsx build.ts "$@"
    ;;
  "test")
    shift
    cd "$SCRIPT_DIR" && npx tsx test.ts "$@"
    ;;
  "benchmark")
    shift
    cd "$SCRIPT_DIR" && npx tsx benchmark.ts "$@"
    ;;
  "help"|*)
    echo "üöÄ Semiont Management Tool"
    echo ""
    echo "Usage: $0 [command] [args...]"
    echo ""
    echo "üî® Development:"
    echo "   start <env>            - Start services in any environment"
    echo "   stop <env>             - Stop services in any environment"  
    echo "   restart <env>          - Restart services in any environment"
    echo "   check                  - Check system health and status"
    echo ""
    echo "üß™ Testing:"
    echo "   test [options]         - Run automated tests"
    echo ""
    echo "üèóÔ∏è Build & Deploy:"
    echo "   build [target]         - Build applications and Docker images"
    echo "   provision <env>        - Create cloud infrastructure (one-time)"
    echo "   deploy <env>           - Deploy application code and configuration"
    echo ""
    echo "üìä Operations:"
    echo "   watch [logs|metrics]   - Monitor logs and system metrics"
    echo "   backup [name]          - Backup database"
    echo "   configure <cmd>        - Configure application settings and secrets"
    echo "   exec [command]         - Execute command in container"
    echo ""
    echo "üîß Utilities:"
    echo "   clean [target]         - Clean build artifacts and caches"
    echo "   benchmark [action]     - Performance benchmarking and analysis"
    echo ""
    echo "Examples:"
    echo "   # Local Development:"
    echo "   $0 start local               # Start all services locally"
    echo "   $0 start local --service frontend --mock  # Frontend with mock API"
    echo "   $0 stop local                # Stop all local services"
    echo ""
    echo "   # Cloud Deployment:"
    echo "   $0 provision production      # One-time infrastructure setup"
    echo "   $0 deploy production         # Deploy code changes to production"
    echo "   $0 start staging --service backend  # Start backend service in staging"
    echo "   $0 restart production --service frontend  # Restart frontend in production"
    echo ""
    echo "   # Operations:"
    echo "   $0 check                     # Check system health"
    echo "   $0 watch logs                # Monitor logs continuously"
    echo "   $0 watch metrics             # Monitor system metrics"
    echo "   $0 test --suite unit --service frontend  # Unit tests for frontend"
    echo ""
    ;;
esac